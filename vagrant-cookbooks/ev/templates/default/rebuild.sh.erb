#!/bin/bash

#################
# Pulls from the integration server

PROJECT="<%= @project_name %>"
NOW=`date +%s`
echo "Currently $NOW"

cd /home/vagrant/workspace/$PROJECT/web

echo "Setting up known_hosts"
rm /home/vagrant/.ssh/known_hosts
/usr/bin/ssh-keyscan -H $PROJECT.integration.aws.elephantventures.com >> /home/vagrant/.ssh/known_hosts

if [ "$1" == "--skip-db" ]
then
  echo "WARNING: Skipping sql-sync"
else
  <% if @skip_tables.length > 0 -%>
  if [ ! "$1" == "--all-tables" ]
    then IGNORE_TABLES="<%= @skip_tables %>"
  fi
  <% end -%>


  DUMP_FILE="dump-$NOW.sql"
  time ssh $PROJECT.integration.aws.elephantventures.com \
        "if [ -a /tmp/$DUMP_FILE ];\
         then\
           echo 'Something is wrong, a sql dump with current timestamp exists, try again.';\
         else\
           mysqldump --result-file /tmp/$DUMP_FILE\
           --no-autocommit --single-transaction --opt -Q $PROJECT\
           --host=10.196.211.165 --user=$PROJECT --password=$PROJECT\
           --order-by-primary $IGNORE_TABLES 2>&1;\
        fi"
  echo "Rsyncing dump to /tmp/$DUMP_FILE"
  time rsync --rsh='ssh ' --archive --copy-dirlinks --compress --verbose --stats\
    --progress --remove-source-files\
    $PROJECT.integration.aws.elephantventures.com:/tmp/$DUMP_FILE /tmp/$DUMP_FILE
  if [ -s /tmp/$DUMP_FILE ]
  then
    # We're going to just drop the entire database, here, and pull a new one down
    drush sql-drop -y
    echo "Loading dump into database"
    time drush sql-cli < /tmp/$DUMP_FILE
 #   rm /tmp/$DUMP_FILE
  else
    echo "/tmp/$DUMP_FILE does not exist or is empty, not updating database"
  fi
fi


echo "Running Compass"
time /home/vagrant/workspace/$PROJECT/bin/compass.sh

echo "Doing drupal upkeep..."
drush updb -y \
  && drush pm-enable devel -y \
  && drush cc drush -y \
  && drush fra -y \
  && drush cc all

echo "Syncing files..."
time rsync --archive --verbose --compress -rsh=ssh $PROJECT.integration.aws.elephantventures.com:/srv/www/$PROJECT/current/web/sites/default/files/ /home/vagrant/workspace/$PROJECT/web/sites/default/files/
